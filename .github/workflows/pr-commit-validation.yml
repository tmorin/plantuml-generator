name: PR Commit Validation

# Only run on pull requests
on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

# Set minimal permissions - only read access needed for validation
permissions:
  contents: read
  pull-requests: read

jobs:
  validate-commits:
    name: Validate PR Commits
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch all commits to validate the entire PR history
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get PR commit count
        id: commit-count
        run: |
          # Get the number of commits in the PR
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          # Count commits between base and head
          COMMIT_COUNT=$(git rev-list --count ${BASE_SHA}..${HEAD_SHA})
          echo "count=${COMMIT_COUNT}" >> $GITHUB_OUTPUT
          echo "üìä This PR has ${COMMIT_COUNT} commit(s)"

      - name: Check single commit requirement
        if: steps.commit-count.outputs.count != '1'
        run: |
          echo "::error::‚ùå PR must have exactly 1 commit before merge"
          echo ""
          echo "This PR currently has ${{ steps.commit-count.outputs.count }} commits."
          echo ""
          echo "üìù To squash your commits, use one of these methods:"
          echo ""
          echo "Method 1 - Interactive rebase:"
          echo "  git rebase -i HEAD~${{ steps.commit-count.outputs.count }}"
          echo "  # Mark the first commit as 'pick' and others as 'squash' or 'fixup'"
          echo "  git push --force-with-lease"
          echo ""
          echo "Method 2 - Soft reset (easier):"
          echo "  git reset --soft HEAD~${{ steps.commit-count.outputs.count }}"
          echo "  git commit -m 'your-new-commit-message'"
          echo "  git push --force-with-lease"
          echo ""
          echo "Method 3 - Use GitHub's 'Squash and merge' button when merging"
          echo ""
          exit 1

      - name: Get PR commits
        id: get-commits
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          # Get commit SHAs
          git rev-list ${BASE_SHA}..${HEAD_SHA} > commits.txt
          echo "‚úÖ Retrieved $(wc -l < commits.txt) commit(s) for validation"

      - name: Validate Conventional Commits format
        run: |
          echo "üîç Validating Conventional Commits format..."
          echo ""
          
          # Conventional Commits regex pattern
          # Format: <type>[optional scope]: <description>
          # Description must be at least 3 characters to ensure meaningful content
          # Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert
          CONVENTIONAL_COMMIT_REGEX='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?(!)?: .{3,}'
          
          VALIDATION_FAILED=0
          
          while IFS= read -r commit_sha; do
            # Get commit message (subject only)
            commit_subject=$(git log --format=%s -n 1 "${commit_sha}")
            commit_author=$(git log --format='%an' -n 1 "${commit_sha}")
            
            echo "üìù Commit: ${commit_sha:0:7}"
            echo "   Author: ${commit_author}"
            echo "   Subject: ${commit_subject}"
            
            # Check if commit follows Conventional Commits
            if ! echo "${commit_subject}" | grep -qE "${CONVENTIONAL_COMMIT_REGEX}"; then
              echo "   ‚ùå FAILED: Does not follow Conventional Commits format"
              echo ""
              VALIDATION_FAILED=1
            else
              echo "   ‚úÖ PASSED: Follows Conventional Commits format"
              echo ""
            fi
          done < commits.txt
          
          if [ ${VALIDATION_FAILED} -eq 1 ]; then
            echo "::error::‚ùå One or more commits do not follow Conventional Commits specification"
            echo ""
            echo "üìö Conventional Commits Format:"
            echo "  <type>[optional scope]: <description>"
            echo ""
            echo "  [optional body]"
            echo ""
            echo "  [optional footer(s)]"
            echo ""
            echo "Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
            echo ""
            echo "Examples:"
            echo "  ‚úÖ feat: add new PlantUML diagram generator"
            echo "  ‚úÖ fix(parser): resolve parsing error for nested elements"
            echo "  ‚úÖ docs: update README with installation instructions"
            echo "  ‚úÖ feat!: breaking change to API"
            echo "  ‚ùå Add new feature (missing type)"
            echo "  ‚ùå feature: add something (invalid type)"
            echo ""
            echo "Learn more: https://www.conventionalcommits.org/"
            exit 1
          fi
          
          echo "‚úÖ All commits follow Conventional Commits format"

      - name: Validate issue/ticket references
        run: |
          echo "üîç Validating issue/ticket references..."
          echo ""
          
          # Pattern to match issue references: #123, GH-123, closes #123, fixes #123, etc.
          # Supported formats:
          #   - Standalone: #123, GH-123
          #   - With keywords: close/closes/closed/fix/fixes/fixed/resolve/resolves/resolved #123
          # Pattern breakdown:
          #   - close[sd]? matches: close, closes, closed
          #   - fix(e[sd])? matches: fix, fixes (fix+es), fixed (fix+ed)
          #   - resolve[sd]? matches: resolve, resolves, resolved
          # Used with grep -i flag for case-insensitive matching
          ISSUE_REFERENCE_REGEX='(#[0-9]+|GH-[0-9]+|(close[sd]?|fix(e[sd])?|resolve[sd]?) #[0-9]+)'
          
          VALIDATION_FAILED=0
          
          while IFS= read -r commit_sha; do
            # Get full commit message (subject + body)
            commit_message=$(git log --format=%B -n 1 "${commit_sha}")
            commit_subject=$(git log --format=%s -n 1 "${commit_sha}")
            
            echo "üìù Commit: ${commit_sha:0:7}"
            echo "   Subject: ${commit_subject}"
            
            # Check if commit message contains issue reference
            if ! echo "${commit_message}" | grep -qiE "${ISSUE_REFERENCE_REGEX}"; then
              echo "   ‚ùå FAILED: No issue/ticket reference found"
              echo ""
              VALIDATION_FAILED=1
            else
              # Extract and display the reference
              issue_ref=$(echo "${commit_message}" | grep -oiE "${ISSUE_REFERENCE_REGEX}" | head -1)
              echo "   ‚úÖ PASSED: Found reference: ${issue_ref}"
              echo ""
            fi
          done < commits.txt
          
          if [ ${VALIDATION_FAILED} -eq 1 ]; then
            echo "::error::‚ùå One or more commits are missing issue/ticket references"
            echo ""
            echo "üìö Issue Reference Requirements:"
            echo "  Every commit must reference an issue or ticket number"
            echo ""
            echo "Valid formats:"
            echo "  - In subject: feat: add feature #123"
            echo "  - In subject: fix(parser): resolve bug (closes #456)"
            echo "  - In body or footer:"
            echo "      feat: add new feature"
            echo "      "
            echo "      This implements the requested functionality."
            echo "      "
            echo "      Closes #123"
            echo ""
            echo "Keywords that link issues:"
            echo "  - close, closes, closed"
            echo "  - fix, fixes, fixed"
            echo "  - resolve, resolves, resolved"
            echo ""
            echo "Examples:"
            echo "  ‚úÖ feat: add PlantUML support #123"
            echo "  ‚úÖ fix: resolve parser error (fixes #456)"
            echo "  ‚úÖ docs: update README"
            echo "     "
            echo "     Closes #789"
            echo "  ‚ùå feat: add new feature (no issue reference)"
            echo ""
            exit 1
          fi
          
          echo "‚úÖ All commits contain issue/ticket references"

      - name: Validation summary
        if: success()
        run: |
          echo "‚úÖ All validations passed!"
          echo ""
          echo "Summary:"
          echo "  ‚úÖ Commit count: ${{ steps.commit-count.outputs.count }}"
          echo "  ‚úÖ Conventional Commits format: Valid"
          echo "  ‚úÖ Issue references: Present"
          echo ""
          echo "üéâ This PR is ready for review!"
