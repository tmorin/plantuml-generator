name: PR Commit Validation

# Only run on pull requests
on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

# Set minimal permissions - only read access needed for validation
permissions:
  contents: read
  pull-requests: read

jobs:
  validate-pr:
    name: Validate PR Title and Description
    runs-on: ubuntu-22.04
    steps:
      - name: Validate PR title (Conventional Commits)
        run: |
          echo "üîç Validating PR title..."
          echo ""
          
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: ${PR_TITLE}"
          echo ""
          
          # Conventional Commits regex pattern
          # Format: <type>[optional scope]: <description>
          # Description must be at least 3 characters to ensure meaningful content
          # Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert
          CONVENTIONAL_COMMIT_REGEX='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?(!)?: .{3,}'
          
          if ! echo "${PR_TITLE}" | grep -qE "${CONVENTIONAL_COMMIT_REGEX}"; then
            echo "::error::‚ùå PR title does not follow Conventional Commits specification"
            echo ""
            echo "üìö PR Title Format (used for squash and merge):"
            echo "  <type>[optional scope]: <description>"
            echo ""
            echo "Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
            echo ""
            echo "Examples:"
            echo "  ‚úÖ feat: add new PlantUML diagram generator"
            echo "  ‚úÖ fix(parser): resolve parsing error for nested elements"
            echo "  ‚úÖ ci: add automated PR validation"
            echo "  ‚úÖ feat!: breaking change to API"
            echo "  ‚ùå Add new feature (missing type)"
            echo "  ‚ùå feature: add something (invalid type)"
            echo "  ‚ùå fix: ab (description too short)"
            echo ""
            echo "Learn more: https://www.conventionalcommits.org/"
            echo ""
            echo "üí° Note: When using 'Squash and merge', the PR title becomes the commit message."
            exit 1
          fi
          
          echo "‚úÖ PR title follows Conventional Commits format"

      - name: Validate PR description (issue reference)
        run: |
          echo ""
          echo "üîç Validating PR description for issue reference..."
          echo ""
          
          PR_BODY="${{ github.event.pull_request.body }}"
          
          # Pattern to match issue references: #123, GH-123, closes #123, fixes #123, etc.
          # Supported formats:
          #   - Standalone: #123, GH-123
          #   - With keywords: close/closes/closed/fix/fixes/fixed/resolve/resolves/resolved #123
          # Pattern breakdown:
          #   - close[sd]? matches: close, closes, closed
          #   - fix(e[sd])? matches: fix, fixes (fix+es), fixed (fix+ed)
          #   - resolve[sd]? matches: resolve, resolves, resolved
          # Used with grep -i flag for case-insensitive matching
          ISSUE_REFERENCE_REGEX='(#[0-9]+|GH-[0-9]+|(close[sd]?|fix(e[sd])?|resolve[sd]?) #[0-9]+)'
          
          if ! echo "${PR_BODY}" | grep -qiE "${ISSUE_REFERENCE_REGEX}"; then
            echo "::error::‚ùå PR description is missing issue/ticket reference"
            echo ""
            echo "üìö Issue Reference Requirements:"
            echo "  PR description must reference an issue or ticket number"
            echo ""
            echo "Valid formats:"
            echo "  - Standalone: #123 or GH-123"
            echo "  - With keywords: Closes #123, Fixes #456, Resolves #789"
            echo ""
            echo "Keywords that automatically close issues:"
            echo "  - close, closes, closed"
            echo "  - fix, fixes, fixed"
            echo "  - resolve, resolves, resolved"
            echo ""
            echo "Example PR description:"
            echo "  This PR adds automated validation for commit messages."
            echo "  "
            echo "  Closes #123"
            echo ""
            echo "üí° Note: When using 'Squash and merge', the PR description is included in the commit body."
            exit 1
          fi
          
          # Extract and display the reference
          issue_ref=$(echo "${PR_BODY}" | grep -oiE "${ISSUE_REFERENCE_REGEX}" | head -1)
          echo "‚úÖ PR description contains issue reference: ${issue_ref}"

      - name: Validation summary
        if: success()
        run: |
          echo ""
          echo "‚úÖ All validations passed!"
          echo ""
          echo "Summary:"
          echo "  ‚úÖ PR title: Follows Conventional Commits format"
          echo "  ‚úÖ PR description: Contains issue reference"
          echo ""
          echo "üéâ This PR is ready to be merged using 'Squash and merge'!"
          echo ""
          echo "‚ÑπÔ∏è  When you use 'Squash and merge':"
          echo "    - The PR title will become the commit message"
          echo "    - The PR description will be included in the commit body"
          echo "    - All commits will be combined into a single commit"
